<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ProperTea</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
*, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
:root {
  --ink:#1c2b1e; --hunter:#2d4a32; --hunter-mid:#3d6644; --hunter-light:#4e7d56;
  --paper:#f5f2ea; --cream:#e8e3d5; --brass:#a8893a; --brass-light:#d4bc7a;
  --slate:#4a5e4d; --white:#fdfbf5;
  --shadow:0 4px 24px rgba(28,43,30,0.14); --radius:10px;
}
html,body { height:100%; width:100%; overflow:hidden; font-family:'DM Sans',sans-serif; background:var(--paper); color:var(--ink); font-size:14px; display:flex; flex-direction:column; }

/* â”€â”€ TOOLBAR â”€â”€ */
.toolbar { height:52px; background:var(--ink); display:flex; align-items:center; justify-content:space-between; padding:0 20px; flex-shrink:0; border-bottom:2px solid var(--hunter-mid); }
.logo { font-family:'Playfair Display',serif; font-size:1.25rem; font-weight:700; color:var(--brass-light); letter-spacing:0.03em; }
.logo span { color:rgba(245,242,234,0.85); font-weight:400; }
.filters { display:flex; gap:6px; align-items:center; }
.filter-btn { padding:5px 13px; border-radius:20px; border:1px solid rgba(168,137,58,0.35); background:transparent; color:rgba(245,242,234,0.6); font-family:'DM Sans',sans-serif; font-size:0.72rem; font-weight:500; cursor:pointer; transition:all 0.2s; letter-spacing:0.04em; text-transform:uppercase; }
.filter-btn.active,.filter-btn:hover { background:var(--brass); border-color:var(--brass); color:var(--white); }
.listing-count { font-size:0.7rem; color:rgba(245,242,234,0.3); margin-left:6px; }

/* â”€â”€ LAYOUT â”€â”€ */
.app { display:flex; flex:1; min-height:0; overflow:hidden; }

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar { width:300px; min-width:300px; background:var(--paper); display:flex; flex-direction:column; border-right:1px solid var(--cream); overflow:hidden; z-index:10; }
.sidebar-header { padding:16px 18px 14px; background:var(--white); border-bottom:1px solid var(--cream); flex-shrink:0; }
.sidebar-header h2 { font-family:'Playfair Display',serif; font-size:1rem; font-weight:600; margin-bottom:3px; color:var(--ink); }
.sidebar-header p { font-size:0.72rem; color:var(--slate); }
.listings-list { flex:1; overflow-y:auto; padding:10px; }
.listings-list::-webkit-scrollbar { width:3px; }
.listings-list::-webkit-scrollbar-thumb { background:var(--hunter-light); border-radius:2px; }

/* â”€â”€ LOADING STATE â”€â”€ */
.loading-state { display:flex; flex-direction:column; align-items:center; justify-content:center; height:200px; gap:12px; color:var(--slate); }
.spinner { width:28px; height:28px; border:3px solid var(--cream); border-top-color:var(--hunter); border-radius:50%; animation:spin 0.8s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }
.loading-state p { font-size:0.78rem; }
.error-state { padding:20px; text-align:center; color:var(--slate); font-size:0.78rem; }
.error-state .err-icon { font-size:1.8rem; margin-bottom:8px; }
.error-state strong { display:block; color:var(--ink); margin-bottom:4px; font-size:0.85rem; }
.retry-btn { margin-top:12px; padding:7px 16px; background:var(--hunter); color:var(--white); border:none; border-radius:7px; font-family:'DM Sans',sans-serif; font-size:0.75rem; font-weight:600; cursor:pointer; transition:background 0.2s; }
.retry-btn:hover { background:var(--brass); }

/* â”€â”€ CARDS â”€â”€ */
.listing-card { background:var(--white); border-radius:var(--radius); margin-bottom:8px; cursor:pointer; border:2px solid transparent; transition:all 0.2s; overflow:hidden; box-shadow:0 2px 6px rgba(28,43,30,0.07); }
.listing-card:hover { border-color:var(--hunter-light); box-shadow:var(--shadow); transform:translateY(-1px); }
.listing-card.active { border-color:var(--hunter); }
.listing-card.hidden { display:none; }
.card-img { height:100px; position:relative; overflow:hidden; background:var(--cream); }
.card-img img { width:100%; height:100%; object-fit:cover; display:block; }
.card-img .no-photo { width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:1.8rem; background:var(--cream); color:var(--slate); opacity:0.5; }
.card-badge { position:absolute; top:8px; left:8px; padding:2px 8px; border-radius:10px; font-size:0.6rem; font-weight:700; letter-spacing:0.06em; text-transform:uppercase; }
.badge-residential { background:var(--hunter); color:var(--white); }
.badge-commercial { background:var(--brass); color:var(--white); }
.badge-other { background:var(--slate); color:var(--white); }
.card-status { position:absolute; top:8px; right:8px; padding:2px 8px; border-radius:10px; font-size:0.6rem; font-weight:700; letter-spacing:0.04em; text-transform:uppercase; background:rgba(253,251,245,0.93); }
.status-active { color:#2d5e35; } .status-pending { color:#8a6010; } .status-closed { color:#8a2020; } .status-other { color:var(--slate); }
.card-body { padding:11px 13px; }
.card-price { font-family:'Playfair Display',serif; font-size:1rem; font-weight:700; color:var(--ink); margin-bottom:3px; }
.card-address { font-size:0.7rem; color:var(--slate); margin-bottom:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.card-meta { display:flex; gap:10px; font-size:0.68rem; color:var(--slate); flex-wrap:wrap; }
.comment-pill { display:inline-flex; align-items:center; gap:3px; font-size:0.65rem; color:var(--hunter-mid); font-weight:500; margin-top:6px; background:#eaf2eb; padding:2px 7px; border-radius:8px; border:1px solid #b8d4bb; }

/* â”€â”€ MAP â”€â”€ */
.map-wrap { flex:1; position:relative; overflow:hidden; }
#map { width:100%; height:100%; min-height:400px; }

/* â”€â”€ DETAIL PANEL â”€â”€ */
.detail-panel { position:absolute; right:0; top:0; bottom:0; width:360px; background:var(--white); box-shadow:-6px 0 32px rgba(28,43,30,0.16); display:flex; flex-direction:column; transform:translateX(100%); transition:transform 0.32s cubic-bezier(0.4,0,0.2,1); z-index:400; overflow:hidden; }
.detail-panel.open { transform:translateX(0); }
.panel-close { position:absolute; top:12px; right:12px; width:30px; height:30px; border-radius:50%; border:1px solid rgba(255,255,255,0.5); background:rgba(28,43,30,0.55); color:var(--white); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:0.9rem; transition:all 0.2s; z-index:2; line-height:1; }
.panel-close:hover { background:var(--ink); }
.panel-img-wrap { height:190px; flex-shrink:0; position:relative; overflow:hidden; background:var(--cream); }
.panel-img-wrap img { width:100%; height:100%; object-fit:cover; display:block; }
.panel-img-wrap .no-photo-lg { width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:3rem; opacity:0.3; }
.panel-img-overlay { position:absolute; bottom:0; left:0; right:0; padding:14px 18px; background:linear-gradient(transparent,rgba(20,36,22,0.75)); }
.panel-price { font-family:'Playfair Display',serif; font-size:1.5rem; font-weight:700; color:var(--white); }
.panel-body { flex:1; overflow-y:auto; padding:18px 20px 28px; }
.panel-body::-webkit-scrollbar { width:3px; }
.panel-body::-webkit-scrollbar-thumb { background:var(--hunter-light); border-radius:2px; }
.panel-title { font-family:'Playfair Display',serif; font-size:1.05rem; font-weight:600; margin-bottom:3px; color:var(--ink); }
.panel-address { font-size:0.76rem; color:var(--slate); margin-bottom:14px; }
.panel-tags { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:16px; }
.panel-tag { padding:3px 10px; border-radius:12px; font-size:0.67rem; font-weight:500; background:var(--cream); color:var(--slate); }
.panel-tag.type-residential { background:#dff0e2; color:#1e4425; border:1px solid #a8ccad; }
.panel-tag.type-commercial { background:#f5eed8; color:#5a4010; border:1px solid var(--brass-light); }
.panel-tag.tag-active { background:#dff0e2; color:#1e4425; border:1px solid #a8ccad; }
.panel-tag.tag-pending { background:#f5eed8; color:#7a5010; border:1px solid #d4bc7a; }
.panel-tag.tag-closed { background:#f5e0e0; color:#6a1a1a; border:1px solid #d4a0a0; }
.details-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:16px; }
.detail-item { background:var(--paper); border-radius:7px; padding:10px 12px; border:1px solid var(--cream); }
.detail-item label { font-size:0.62rem; color:var(--slate); text-transform:uppercase; letter-spacing:0.06em; display:block; margin-bottom:3px; }
.detail-item span { font-size:0.85rem; font-weight:600; color:var(--ink); }
.panel-desc { font-size:0.78rem; color:var(--slate); line-height:1.65; margin-bottom:20px; }

/* â”€â”€ MLS BADGE â”€â”€ */
.mls-badge { display:inline-flex; align-items:center; gap:5px; font-size:0.65rem; color:var(--slate); background:var(--paper); border:1px solid var(--cream); border-radius:6px; padding:4px 8px; margin-bottom:16px; }
.mls-badge strong { color:var(--hunter); }

/* â”€â”€ COMMENTS â”€â”€ */
.comments-section { border-top:1px solid var(--cream); padding-top:18px; }
.comments-title { font-family:'Playfair Display',serif; font-size:0.95rem; font-weight:600; color:var(--ink); margin-bottom:14px; display:flex; align-items:center; gap:7px; }
.comments-title .count { background:var(--hunter); color:var(--white); width:20px; height:20px; border-radius:50%; font-family:'DM Sans',sans-serif; font-size:0.67rem; font-weight:700; display:flex; align-items:center; justify-content:center; }
.comment-form { margin-bottom:16px; }
.c-input,.c-textarea { width:100%; border:1px solid var(--cream); border-radius:7px; font-family:'DM Sans',sans-serif; font-size:0.78rem; color:var(--ink); background:var(--paper); transition:border-color 0.2s; display:block; }
.c-input { padding:8px 12px; margin-bottom:7px; }
.c-textarea { padding:9px 12px; resize:vertical; min-height:70px; margin-bottom:9px; }
.c-input:focus,.c-textarea:focus { outline:none; border-color:var(--hunter-mid); }
.c-submit { padding:8px 18px; background:var(--hunter); color:var(--white); border:none; border-radius:7px; font-family:'DM Sans',sans-serif; font-size:0.75rem; font-weight:600; cursor:pointer; letter-spacing:0.03em; transition:all 0.2s; }
.c-submit:hover { background:var(--brass); }
.comments-list { display:flex; flex-direction:column; gap:10px; }
.comment-item { background:var(--paper); border-radius:9px; padding:12px 14px; animation:fadeUp 0.28s ease; border:1px solid var(--cream); }
@keyframes fadeUp { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
.comment-header { display:flex; align-items:center; gap:9px; margin-bottom:7px; }
.c-avatar { width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.7rem; font-weight:700; color:var(--white); flex-shrink:0; }
.c-meta { flex:1; }
.c-name { font-size:0.78rem; font-weight:600; color:var(--ink); }
.c-time { font-size:0.65rem; color:var(--slate); }
.c-text { font-size:0.76rem; color:var(--slate); line-height:1.55; }
.c-del { background:none; border:none; cursor:pointer; color:var(--slate); font-size:0.7rem; opacity:0.4; transition:opacity 0.2s; padding:2px 4px; }
.c-del:hover { opacity:1; color:#8a2020; }
.no-comments { text-align:center; padding:20px; color:var(--slate); font-size:0.75rem; background:var(--paper); border-radius:9px; border:1px dashed var(--cream); }

/* â”€â”€ LEAFLET POPUP â”€â”€ */
.leaflet-popup-content-wrapper { border-radius:9px; box-shadow:0 8px 28px rgba(28,43,30,0.18); padding:0; overflow:hidden; }
.leaflet-popup-content { margin:0; }
.popup-inner { padding:12px 14px; min-width:175px; }
.popup-inner strong { font-family:'Playfair Display',serif; font-size:0.95rem; display:block; margin-bottom:2px; color:#1c2b1e; }
.popup-inner small { color:#4a5e4d; font-size:0.7rem; font-family:'DM Sans',sans-serif; }
.popup-btn { display:block; width:100%; margin-top:9px; padding:7px; background:#2d4a32; color:#fdfbf5; border:none; border-radius:6px; font-family:'DM Sans',sans-serif; font-size:0.72rem; font-weight:600; cursor:pointer; transition:background 0.2s; text-align:center; }
.popup-btn:hover { background:#a8893a; }
</style>
</head>
<body>

<div class="toolbar">
  <div class="logo">Proper<span>Tea</span></div>
  <div class="filters">
    <button class="filter-btn active" onclick="setFilter('all',this)">All</button>
    <button class="filter-btn" onclick="setFilter('residential',this)">Residential</button>
    <button class="filter-btn" onclick="setFilter('commercial',this)">Commercial</button>
    <span class="listing-count" id="countLabel"></span>
  </div>
</div>

<div class="app">
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Available Properties</h2>
      <p>Click a listing or pin to view details &amp; comments</p>
    </div>
    <div class="listings-list" id="listingsList">
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Loading MLS listingsâ€¦</p>
      </div>
    </div>
  </div>

  <div class="map-wrap">
    <div id="map"></div>
    <div class="detail-panel" id="detailPanel">
      <button class="panel-close" onclick="closePanel()">&#x2715;</button>
      <div class="panel-img-wrap" id="panelImgWrap">
        <div class="panel-img-overlay"><div class="panel-price" id="pPrice"></div></div>
      </div>
      <div class="panel-body">
        <div class="panel-title" id="pTitle"></div>
        <div class="panel-address" id="pAddr"></div>
        <div class="panel-tags" id="pTags"></div>
        <div id="pMLS"></div>
        <div class="details-grid" id="pGrid"></div>
        <div class="panel-desc" id="pDesc"></div>
        <div class="comments-section">
          <div class="comments-title">Comments <span class="count" id="cCount">0</span></div>
          <div class="comment-form">
            <input type="text" class="c-input" id="cName" placeholder="Your name">
            <textarea class="c-textarea" id="cText" placeholder="Share your thoughts on this propertyâ€¦"></textarea>
            <button class="c-submit" onclick="addComment()">Post Comment</button>
          </div>
          <div class="comments-list" id="cList"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIMPLYRETS CONFIG
//  Sandbox credentials are pre-filled below for testing.
//  When you get real MLS access, replace these with your own:
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var SIMPLYRETS_USER = 'simplyrets';       // â† replace with your username
var SIMPLYRETS_PASS = 'simplyrets';       // â† replace with your password
var SIMPLYRETS_LIMIT = 25;               // listings to load per fetch
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var listings = [];
var comments = {};   // keyed by listing mlsId
var activeFilter = 'all';
var activeId = null;
var markers = {};
var map;
var avatarColors = ['#2d4a32','#a8893a','#3d6644','#5a4a2a','#4a6e50','#7a6030'];

document.addEventListener('DOMContentLoaded', function(){ initApp(); });

function initApp(){
  // Init map
  map = L.map('map',{preferCanvas:true}).setView([29.76,-95.36],10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    maxZoom:19
  }).addTo(map);
  setTimeout(function(){ map.invalidateSize(); }, 300);

  // Fetch listings from SimplyRETS
  fetchListings();
}

// â”€â”€ SIMPLYRETS FETCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fetchListings(){
  showLoading();

  var url = 'https://api.simplyrets.com/properties?limit=' + SIMPLYRETS_LIMIT + '&status=Active';
  var auth = 'Basic ' + btoa(SIMPLYRETS_USER + ':' + SIMPLYRETS_PASS);

  fetch(url, { headers:{ 'Authorization': auth, 'Accept': 'application/json' } })
    .then(function(res){
      if(!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    })
    .then(function(data){
      if(!data || !data.length){ showError('No listings returned from the API.'); return; }
      listings = data.map(mapListing);
      renderSidebar();
      addMarkers();
      // Fit map to all markers
      var coords = listings.filter(function(l){ return l.lat && l.lng; }).map(function(l){ return [l.lat,l.lng]; });
      if(coords.length) map.fitBounds(coords, {padding:[40,40]});
    })
    .catch(function(err){
      console.error('SimplyRETS error:', err);
      showError('Could not load listings. Check your API credentials or network connection.');
    });
}

// â”€â”€ MAP SIMPLYRETS RESPONSE TO OUR LISTING FORMAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mapListing(p){
  var prop = p.property || {};
  var addr = p.address || {};
  var geo  = p.geo || {};
  var agent = p.agent || {};
  var office = p.office || {};

  // Determine type
  var subType = (prop.subType || prop.type || '').toLowerCase();
  var type = 'residential';
  if(subType.indexOf('commercial') > -1 || subType.indexOf('business') > -1) type = 'commercial';

  // Status normalisation
  var rawStatus = (p.mls && p.mls.status) ? p.mls.status.toLowerCase() : 'active';
  var status = rawStatus.indexOf('pend') > -1 ? 'pending'
             : rawStatus.indexOf('clos') > -1 || rawStatus.indexOf('sold') > -1 ? 'closed'
             : 'active';

  // Address string
  var fullAddr = [addr.streetNumber, addr.streetName, addr.city, addr.state, addr.postalCode]
    .filter(Boolean).join(' ');

  // Photos
  var photos = p.photos || [];

  return {
    id:       p.mlsId || String(Math.random()),
    mlsId:    p.mlsId || 'â€”',
    type:     type,
    subType:  prop.subType || prop.type || 'Residential',
    status:   status,
    price:    p.listPrice ? '$' + Number(p.listPrice).toLocaleString() : 'Price N/A',
    title:    prop.style || prop.subType || 'Property',
    address:  fullAddr || 'Address unavailable',
    beds:     prop.bedrooms || 'â€”',
    baths:    prop.bathsFull || 'â€”',
    sqft:     prop.area ? Number(prop.area).toLocaleString() : 'â€”',
    year:     prop.yearBuilt || 'â€”',
    lotSize:  prop.lotSize ? prop.lotSize + ' acres' : 'â€”',
    desc:     p.remarks || 'No description provided.',
    img:      photos.length ? photos[0] : null,
    lat:      geo.lat || null,
    lng:      geo.lng || null,
    agentName:  agent.firstName ? agent.firstName + ' ' + (agent.lastName||'') : null,
    officeName: office.name || null,
    comments: []
  };
}

// â”€â”€ MARKERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addMarkers(){
  // Clear existing
  Object.values(markers).forEach(function(m){ map.removeLayer(m); });
  markers = {};

  listings.forEach(function(l){
    if(!l.lat || !l.lng) return;
    var m = L.marker([l.lat,l.lng],{icon:mkIcon(l,false)});
    m.bindPopup(L.popup({closeButton:false,maxWidth:230}).setContent(
      '<div class="popup-inner"><strong>'+esc(l.title)+'</strong><small>'+esc(l.address)+'</small>'+
      '<button class="popup-btn" onclick="openListing(\''+l.id+'\')">View Details &amp; Comments</button></div>'
    ));
    m.on('click',function(){ resetIcons(); if(markers[l.id]) markers[l.id].setIcon(mkIcon(l,true)); });
    m.addTo(map);
    markers[l.id] = m;
  });
}

function mkIcon(l,sel){
  var bg=sel?'#a8893a':'#2d4a32', fg='#fdfbf5';
  var bd=l.type==='residential'?'#4e7d56':'#a8893a';
  var h='<div style="background:'+bg+';color:'+fg+';padding:5px 10px;border-radius:18px;font-size:10px;font-weight:700;white-space:nowrap;cursor:pointer;font-family:DM Sans,sans-serif;box-shadow:0 3px 10px rgba(28,43,30,.4);border:2px solid '+bd+';position:relative;">'+l.price+'<div style="position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:'+bg+';border-bottom:none;"></div></div>';
  return L.divIcon({html:h,className:'',iconAnchor:[46,34],popupAnchor:[0,-38]});
}

function resetIcons(){ listings.forEach(function(l){ if(markers[l.id]) markers[l.id].setIcon(mkIcon(l,false)); }); }

// â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSidebar(){
  var filtered = listings.filter(function(l){ return activeFilter==='all'||l.type===activeFilter; });
  document.getElementById('countLabel').textContent = filtered.length + ' listing' + (filtered.length!==1?'s':'');
  var container = document.getElementById('listingsList');
  container.innerHTML = '';

  if(!filtered.length){
    container.innerHTML = '<div class="error-state"><div class="err-icon">ğŸ </div><strong>No listings found</strong>Try a different filter.</div>';
    return;
  }

  listings.forEach(function(l){
    var vis = activeFilter==='all' || l.type===activeFilter;
    var el = document.createElement('div');
    el.className = 'listing-card' + (l.id===activeId?' active':'') + (vis?'':' hidden');
    el.dataset.id = l.id;
    var imgHtml = l.img
      ? '<img src="'+esc(l.img)+'" loading="lazy" alt="'+esc(l.title)+'">'
      : '<div class="no-photo">ğŸ¡</div>';
    var meta = l.type==='residential'
      ? '<span>&#x1F6CF; '+l.beds+' bed</span><span>&#x1F6C1; '+l.baths+' bath</span><span>'+l.sqft+' sqft</span>'
      : '<span>&#x1F4D0; '+l.sqft+' sqft</span>';
    var cc = l.comments.length;
    var statusClass = 'status-' + l.status;
    el.innerHTML =
      '<div class="card-img">'+imgHtml+
      '<span class="card-badge badge-'+l.type+'">'+l.type+'</span>'+
      '<span class="card-status '+statusClass+'">'+l.status+'</span></div>'+
      '<div class="card-body">'+
        '<div class="card-price">'+l.price+'</div>'+
        '<div class="card-address">'+esc(l.address)+'</div>'+
        '<div class="card-meta">'+meta+'</div>'+
        (cc>0?'<div class="comment-pill">&#x1F4AC; '+cc+' comment'+(cc!==1?'s':'')+'</div>':'')+
      '</div>';
    el.addEventListener('click',function(){ openListing(l.id); });
    container.appendChild(el);
  });
}

function setFilter(type,btn){
  activeFilter = type;
  document.querySelectorAll('.filter-btn').forEach(function(b){ b.classList.remove('active'); });
  btn.classList.add('active');
  listings.forEach(function(l){
    var m = markers[l.id]; if(!m) return;
    if(type==='all'||l.type===type) m.addTo(map); else map.removeLayer(m);
  });
  renderSidebar();
}

// â”€â”€ DETAIL PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openListing(id){
  activeId = id;
  var l = listings.find(function(x){ return x.id===id; });
  if(!l) return;

  document.querySelectorAll('.listing-card').forEach(function(c){ c.classList.toggle('active', c.dataset.id===id); });

  if(l.lat && l.lng){
    map.flyTo([l.lat,l.lng],15,{duration:1});
    resetIcons();
    if(markers[id]){ markers[id].setIcon(mkIcon(l,true)); markers[id].openPopup(); }
  }

  // Image or placeholder
  var imgWrap = document.getElementById('panelImgWrap');
  imgWrap.innerHTML = '';
  if(l.img){
    var img = document.createElement('img');
    img.src = l.img; img.alt = l.title;
    imgWrap.appendChild(img);
  } else {
    var ph = document.createElement('div');
    ph.className = 'no-photo-lg'; ph.textContent = 'ğŸ¡';
    imgWrap.appendChild(ph);
  }
  var overlay = document.createElement('div');
  overlay.className = 'panel-img-overlay';
  overlay.innerHTML = '<div class="panel-price">'+l.price+'</div>';
  imgWrap.appendChild(overlay);

  document.getElementById('pTitle').textContent = l.title;
  document.getElementById('pAddr').textContent = l.address;

  // Tags
  document.getElementById('pTags').innerHTML =
    '<span class="panel-tag type-'+l.type+'">'+cap(l.type)+'</span>'+
    '<span class="panel-tag tag-'+l.status+'">'+cap(l.status)+'</span>'+
    (l.subType ? '<span class="panel-tag">'+esc(l.subType)+'</span>' : '')+
    (l.year !== 'â€”' ? '<span class="panel-tag">Built '+l.year+'</span>' : '');

  // MLS badge
  document.getElementById('pMLS').innerHTML =
    '<div class="mls-badge">&#x1F4CB; MLS# <strong>'+esc(String(l.mlsId))+'</strong>'+
    (l.agentName ? ' &nbsp;|&nbsp; Agent: <strong>'+esc(l.agentName)+'</strong>' : '')+
    (l.officeName ? ' &nbsp;|&nbsp; '+esc(l.officeName) : '')+'</div>';

  // Details grid
  document.getElementById('pGrid').innerHTML =
    dItem('Price', l.price) +
    dItem('Sq Ft', l.sqft) +
    (l.type==='residential' ? dItem('Bedrooms', l.beds) + dItem('Bathrooms', l.baths) : '') +
    dItem('Year Built', l.year) +
    dItem('Lot Size', l.lotSize);

  document.getElementById('pDesc').textContent = l.desc;
  renderComments(l);
  document.getElementById('detailPanel').classList.add('open');
}

function dItem(l,v){ return '<div class="detail-item"><label>'+l+'</label><span>'+v+'</span></div>'; }

function closePanel(){
  document.getElementById('detailPanel').classList.remove('open');
  activeId = null;
  document.querySelectorAll('.listing-card').forEach(function(c){ c.classList.remove('active'); });
  resetIcons(); map.closePopup();
}

// â”€â”€ COMMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderComments(l){
  document.getElementById('cCount').textContent = l.comments.length;
  var list = document.getElementById('cList');
  if(!l.comments.length){
    list.innerHTML = '<div class="no-comments"><div style="font-size:1.4rem;margin-bottom:6px">&#x1F4AC;</div>No comments yet â€” be the first!</div>';
    return;
  }
  list.innerHTML = l.comments.map(function(c,i){
    var col = c.color || avatarColors[i % avatarColors.length];
    return '<div class="comment-item"><div class="comment-header">'+
      '<div class="c-avatar" style="background:'+col+'">'+esc(c.author.charAt(0).toUpperCase())+'</div>'+
      '<div class="c-meta"><div class="c-name">'+esc(c.author)+'</div><div class="c-time">'+c.time+'</div></div>'+
      '<button class="c-del" onclick="delComment(\''+l.id+'\',\''+c.id+'\')">&#x2715;</button>'+
      '</div><div class="c-text">'+esc(c.text)+'</div></div>';
  }).join('');
  renderSidebar();
}

function addComment(){
  if(!activeId) return;
  var l = listings.find(function(x){ return x.id===activeId; });
  var name = document.getElementById('cName').value.trim();
  var text = document.getElementById('cText').value.trim();
  if(!name||!text){ alert('Please enter your name and a comment.'); return; }
  l.comments.push({id:'c'+Date.now(), author:name, text:text, time:'Just now', color:avatarColors[l.comments.length % avatarColors.length]});
  document.getElementById('cName').value = '';
  document.getElementById('cText').value = '';
  renderComments(l);
}

function delComment(lid,cid){
  var l = listings.find(function(x){ return x.id===lid; });
  if(!l) return;
  l.comments = l.comments.filter(function(c){ return c.id!==cid; });
  renderComments(l);
}

// â”€â”€ UI STATES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLoading(){
  document.getElementById('listingsList').innerHTML =
    '<div class="loading-state"><div class="spinner"></div><p>Loading MLS listingsâ€¦</p></div>';
  document.getElementById('countLabel').textContent = '';
}

function showError(msg){
  document.getElementById('listingsList').innerHTML =
    '<div class="error-state"><div class="err-icon">âš ï¸</div><strong>Could not load listings</strong>'+esc(msg)+
    '<br><button class="retry-btn" onclick="fetchListings()">Try Again</button></div>';
  document.getElementById('countLabel').textContent = '';
}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

window.addEventListener('resize',function(){ if(map) setTimeout(function(){ map.invalidateSize(); },100); });
window.addEventListener('load',function(){ if(map) setTimeout(function(){ map.invalidateSize(); },200); });
</script>
</body>
</html>
